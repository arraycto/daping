(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-017b3e41"],{bd81:function(e,t,a){},df2c:function(e,t,a){"use strict";a("bd81")},e7db:function(e,t,a){"use strict";a.r(t);var i=function(){var e=this,t=e.$createElement,a=e._self._c||t;return e.drillEnable&&this.layerObj&&this.layerObj.index>e.topIndex?a("el-button",{staticStyle:{position:"absolute",top:"10px",right:"10px","z-index":"9999"},attrs:{type:"primary",icon:"el-icon-back",size:"mini"},on:{click:e.manageUpDrill}},[e._v("返回 ")]):e._e()},s=[],r=(a("445a"),a("72b3"),a("a543"),a("cca2"),a("b131"),a("dede"),a("989e"),a("1d7a"),a("d0bf"),a("fae2"),a("402f"),a("a5932"),a("0bd5"),a("2db5"),a("9b42"),a("79a8"),a("270f"),a("6ab7"),a("28f8")),n=a("4c09"),l=a("96fa"),o=(a("6a61"),a("2e91")),c=a("b897"),f=a("ef1d"),h=a("0e0b"),d={name:"regionVector",mixins:[c["a"]],data:function(){return{rStyles:null,topIndex:1e3,themes:[],refType:"",clickStyle:{},hoverStyle:{},gisData:[],data:[],layerObj:null,drillEnable:!1,drillField:"",defaultParams:null,showLayer:!0}},created:function(){this.showLayer=this.styleConf.defaultShowLayer,this.processStyle(this.styleConf.refType)},methods:{styleConfChanged:function(){this.refType!==this.styleConf.refType&&(this.rStyles=null,this.refType=this.styleConf.refType),this.processStyle(this.styleConf.refType),this.notifyBase()},convertChartData:function(e){var t=this;return Object(o["a"])(regeneratorRuntime.mark((function a(){var i,s,r,n,l,o,c,f,h;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t.drillEnable=!1,"dataset"!==t.compConf.data.datasource.type){a.next=6;break}for(i=t._convertDatasetToGeoJson(e),s=0;s<i.length;s++){for(r=!1,n=0;n<t.data.length;n++)t.data[n].name===i[s].name&&(t.data[n]=i[s],r=!0);r||t.data.push(i[s])}a.next=23;break;case 6:if("gisServer"!==t.compConf.data.datasource.type){a.next=13;break}return l=_.cloneDeep(t.compConf.data.conf.sevLayer),a.next=10,t.loadGisFeat(l);case 10:t.data=a.sent,a.next=23;break;case 13:if("gisSet"!==t.compConf.data.datasource.type){a.next=22;break}if(o=_.cloneDeep(t.compConf.data.conf.sevLayer),!(o&&o.layerObj&&o.layerObj.length>0)){a.next=19;break}return a.next=18,t.loadGisFeat(o);case 18:t.gisData=a.sent;case 19:t.dataConf.datasetSelectedIds.length>0&&t.dataConf[t.dataConf.datasetSelectedIds[0]]&&(c=t.dataConf[t.dataConf.datasetSelectedIds[0]].properties,f=t.dataConf[t.dataConf.datasetSelectedIds[0]].refGisField,h=t.dataConf[t.dataConf.datasetSelectedIds[0]].refSetField,c&&c.length>0&&f&&h&&(-1===c.indexOf(h)&&t.$message({type:"error",message:"数据集中不包含关联字段，请重新选择"}),t.data=t.relDataToSet(e,c,f,h))),a.next=23;break;case 22:t.data=e;case 23:t.notifyBase(),t.bindEvent();case 25:case"end":return a.stop()}}),a)})))()},loadGisFeat:function(e){var t=this;return Object(o["a"])(regeneratorRuntime.mark((function a(){var i,s,r,n,o,c,f,h,d,y,p,u;return regeneratorRuntime.wrap((function(a){while(1)switch(a.prev=a.next){case 0:e.layerObj.sort((function(e,t){return e.index>=t.index?1:-1})),t.defaultParams=e.defaultParams,i=[],s=!0,r=0;case 5:if(!(r<e.layerObj.length)){a.next=27;break}if(n=e.layerObj[r],o=n.url,c=_.cloneDeep(n.selectedFields),f={},h={datasource:n.datasource,name:n.name},-1===c.indexOf("*")){a.next=19;break}return f.outFields="*",a.next=15,t.gisBase.fieldsService(o,h);case 15:d=a.sent,h.fields=d,a.next=22;break;case 19:y=c.join(","),f.outFields=y,h.fields=c;case 22:-1===c.indexOf(e.serverObj.drillField)&&(s=!1),"sm"===e.serverObj.type?(p=t.gisBase.queryGisDataSm(o,h),i.push(p)):(u=t.gisBase.queryGisData(o,f),i.push(u));case 24:r++,a.next=5;break;case 27:return s&&e.layerObj.length>=2&&e.serverObj.enableDrill&&!_.isEmpty(e.serverObj.drillField)&&(t.drillEnable=!0,t.drillField=e.serverObj.drillField),a.next=30,Promise.all(i).then((function(a){var i=Object(l["a"])(a),s=i.slice(0),r=[];t.topIndex=e.layerObj[0].index;for(var n=0;n<s.length;n++){for(var o={type:"Region",index:e.layerObj[n].index,datasetMeta:[],name:e.layerObj[n].name,feats:s[n].features},c=0;c<e.layerObj[n].fields.length;c++)-1===e.layerObj[n].selectedFields.indexOf(e.layerObj[n].fields[c].name)&&-1===e.layerObj[n].selectedFields.indexOf("*")||o.datasetMeta.push(e.layerObj[n].fields[c]);r.push(o)}return r}));case 30:return a.abrupt("return",a.sent);case 31:case"end":return a.stop()}}),a)})))()},processStyle:function(e){this.clickStyle=this.styleConf.clickStyle,this.hoverStyle=this.styleConf.hoverStyle;var t={unique:{index:0,style:[]},clazz:{},range:{}};switch(e){case"unique":t.unique.style=this._styleParser(this.styleConf.refInfo.regionStyles,e);break;case"clazz":t.clazz=this._styleParser(this.styleConf.refInfo["class"],e);break;case"range":t.range=this._styleParser(this.styleConf.refInfo.seg,e);break}this.rStyles=t},_styleParser:function(e,t){var a;a="unique"===t?[]:{};var i=0;if("click"===t||"hover"===t)return a[t]={fillColor:e[0].fillColor,fillOpacity:e[0].fillOpacity,opacity:e[0].opacity,weight:e[0].weight,color:e[0].color},a;var s=this.getColorsByCount(e.length);return s&&s.length>0&&e.forEach((function(e){var r={fillColor:s[i],fillOpacity:e.opacity,opacity:e.opacity,weight:e.weight,color:e.color};r.bkStyle=r,"unique"===t?a.push(r):"clazz"===t?(r.clz=e.clz,a[r.clz]=r):"range"===t?(r.f=e.f,r.t=e.t,a["".concat(r.f,"-").concat(r.t)]=r):a[t]=r,i++})),a},_calcStyle:function(e,t,a){if(!t||""===t||!a.hasOwnProperty(t))return null;var i=a[t];if("unique"===e){var s=this.styleConf.refInfo.filters.split(",");if(""===i||-1===s.indexOf(i)){var r=this.rStyles.unique;if(r.style.length>0){if(r.index<r.style.length){var n=r.style[r.index];return r.index=r.index+1,n}return r.index=0,r.style[r.index]}}}else if("clazz"===e){var l=this.rStyles.clazz;if(Object.keys(l).length>0)for(var o in l)if(i===o)return l[o]}else if("range"===e){var c=this.rStyles.range;if(i=parseFloat(i),Object.keys(c).length>0){var f=null;for(var h in c){if(f)break;var d=parseFloat(h.split("-")[0]),y=parseFloat(h.split("-")[1]);f=d<=y?i>=d&&i<y?c[h]:null:i>=y&&i<d?c[h]:null}return f}}return null},getColorsByCount:function(e){if(this.styleConf.themes&&this.styleConf.themes.length>0){if(this.styleConf.themes.length>=e)return _.cloneDeep(this.styleConf.themes).splice(0,e);for(var t=[],a=0;a<this.styleConf.themes.length;a++)t.push(this.styleConf.themes[a]);var i=e-t.length,s=_.cloneDeep(t).splice(0,i);return[].concat(t,Object(n["a"])(s))}return null},rgbToArr:function(e){return"string"===typeof e?(e=e.replace(/\s+/g,""),e=(/rgb?\((.*?)\)/.exec(e)||["","0,0,0"])[1].split(","),{r:Number(e[0])||0,g:Number(e[1])||0,b:Number(e[2])||0}):e},buildRegionVector:function(e){var t=this,a=this.styleConf.refType,i=this.styleConf.ref;this.styleConf.dynamicRef&&(i=this.convertExpression(this.styleConf.ref),-1!==i.indexOf("${")&&this.defaultParams&&(i=this.convertExpression(this.defaultParams)));var s=this.styleConf.name,r=this,n=e.feats,l=f["geoJSON"]({type:"FeatureCollection",features:n},{onEachFeature:function(e,t){t.properties=e.properties}});l.id=h["a"].guid(),l.index=e.index,l.name=s&&""!==s?s:"line_"+h["a"].guid();var o=[];l.eachLayer((function(e){var s=r._calcStyle(a,i,e.properties);if(s){e.setStyle(s);var n=r.generateTipContent(e.properties);n&&""!==n&&e.bindTooltip(n,{sticky:!0,direction:"auto",className:"dark-tip"}),e.on("click",(function(e){t.featClick(r,e)})),e.on("mouseover",(function(e){t.featHover(r,e)})),e.on("mouseout",(function(e){t.featStatusClean(r,e)})),e._group=l}else o.push(e)}));for(var c=0;c<o.length;c++)l.removeLayer(o[c]);return 0===l._layers.length?null:l},generateTipContent:function(e){if(0===this.styleConf.tooltip.items.length)return null;for(var t=this.styleConf.tooltip.items,a='<div style="padding: 10px;width: auto">',i={},s=0;s<t.length;s++){var r=t[s];i[r.ref]=r.refAlias}var n=this.styleConf.ref;for(var l in this.styleConf.dynamicRef&&(n=this.convertExpression(this.styleConf.ref)),e){var o=void 0;if(l===n&&(o=this.styleConf.ref),i.hasOwnProperty(l)||i.hasOwnProperty(o)){var c=i[l]&&""!==i[l]?i[l]:l;i.hasOwnProperty(o)&&(c=i[o]),a+='<div style="display: flex">\n                               <div style="max-width:140px;text-align: right">'.concat(c.toUpperCase(),'：</div>\n                               <div style="text-align: left">').concat(e[l],"</div>\n                               </div>")}}return a+="</div>",a},featClick:function(e,t){if(e.loadLinkage(t.target.properties),this.clickStyle&&this.clickStyle.enable){var a=null;if(t.target._group.eachLayer((function(e){e.setStyle(e.options.bkStyle),e.selected&&(a=e)})),t.target.selected)return void(t.target.selected=!1);a&&a._leaflet_id!==t.target._leaflet_id&&(a.selected=!1);var i=this._styleParser([this.clickStyle],"click"),s=t.target.options,r=s.weight,n=s.color,l=s.opacity,o=s.dashArray,c=s.dashOffset;i.click.bkClickStyle={weight:r,color:n,opacity:l,dashArray:o,dashOffset:c},i.click.bkStyle={weight:t.target.options.bkStyle.weight,color:t.target.options.bkStyle.color,opacity:t.target.options.bkStyle.opacity,filOpacity:t.target.options.bkStyle.filOpacity,fillColor:t.target.options.bkStyle.fillColor},t.target.setStyle(i.click),t.target.selected=!0}if(e.drillEnable){var f=t.target.properties[e.drillField],h=t.target._group.index;e.manageDownDrill(f,h)}},featHover:function(e,t){if(this.hoverStyle&&this.hoverStyle.enable){if(t.target._group.eachLayer((function(e){e.selected||(e.setStyle(e.options.bkStyle),e.closeTooltip())})),t.target.selected)return;var a=this._styleParser([this.hoverStyle],"hover"),i=t.target.options,s=i.weight,r=i.color,n=i.opacity,l=i.dashArray,o=i.dashOffset;a.hover.bkHoverStyle={weight:s,color:r,opacity:n,dashArray:l,dashOffset:o},a.hover.bkStyle={weight:t.target.options.bkStyle.weight,color:t.target.options.bkStyle.color,opacity:t.target.options.bkStyle.opacity,filOpacity:t.target.options.bkStyle.filOpacity,fillColor:t.target.options.bkStyle.fillColor},this.styleConf.tooltip&&this.styleConf.tooltip.enable&&t.target.openTooltip(),t.target.setStyle(a.hover)}},featStatusClean:function(e,t){t.target._group.eachLayer((function(e){e.selected||(e.setStyle(e.options.bkStyle),e.closeTooltip())}))},manageDownDrill:function(e,t){for(var a=t+1,i=null,s=0;s<this.data.length;s++)this.data[s].index===a&&(i=this.data[s]);if(i){var r=e.substr(0,2*t),n={name:i.name,type:"Region",index:i.index,feats:[]};this._updateDataMeta(i.datasetMeta);for(var l=0;l<i.feats.length;l++){var o=i.feats[l].properties[this.drillField];o.substr(0,r.length)===r&&n.feats.push(i.feats[l])}this.layerObj=this.buildRegionVector(n),this.layerObj?this.$emit("updateVecLayer",{id:this.compConf.compId,type:"region",layerObj:this.layerObj}):this.$emit("clearVecLayer",{id:this.compConf.compId})}},manageUpDrill:function(){if(this.layerObj){var e=this.layerObj.index;if(!(e-1<0)){for(var t=this.layerObj.getLayers()[0].properties[this.drillField],a=null,i=e-1,s=0;s<this.data.length;s++)this.data[s].index===i&&(a=this.data[s]);if(a){var r=t.substr(0,2*(e-2)),n={name:a.name,type:"Region",index:a.index,feats:[]};this._updateDataMeta(a.datasetMeta);for(var l=0;l<a.feats.length;l++){if(i===this.topIndex){n.feats=a.feats;break}var o=a.feats[l].properties[this.drillField];o.substr(0,r.length)===r&&n.feats.push(a.feats[l])}this.layerObj=this.buildRegionVector(n),this.layerObj?this.$emit("updateVecLayer",{id:this.compConf.compId,type:"region",layerObj:this.layerObj}):this.$emit("clearVecLayer",{id:this.compConf.compId})}}}},_updateDataMeta:function(e){this.$store.getters.getPreviewState?this.$store.commit("modifyValueByGIS",{attrs:[this.compConf.compId,"data","conf","datasetMeta"],value:e}):this.$store.commit("modifyValueByCompId",{attrs:[this.compConf.compId,"data","conf","datasetMeta"],value:e})},notifyBase:function(){if(this.gisBase){if(this.data&&this.data.length>0){var e=this.data[0];"gisServer"===this.compConf.data.datasource.type&&this._updateDataMeta(e.datasetMeta),this.layerObj=this.buildRegionVector(e)}else this.layerObj=null;this.layerObj?this.$emit("updateVecLayer",{id:this.compConf.compId,type:"region",layerObj:this.layerObj,show:this.showLayer}):this.$emit("clearVecLayer",{id:this.compConf.compId,show:this.showLayer})}},getStyleObj:function(){if(!this.styleConf.legend||!this.layerObj)return null;var e=this.rStyles[this.styleConf.refType],t=[];if(e.hasOwnProperty("style")&&e.hasOwnProperty("index"))for(var a=0;a<e.style.length;a++)t.push({name:"",style:e.style[a]});else for(var i in e)t.push({name:i,style:e[i]});return{id:this.layerObj.id,name:this.compConf.name,type:"Region",list:t}},bindEvent:function(){if(this.compConf.linkage&&this.compConf.linkage.linkRevEvents)for(var e=this.compConf.linkage.linkRevEvents,t=0;t<e.length;t++){var a=e[t],i=a.evtName.split(":")[1];"click"===i&&this._clickByLinkAge(a)}},toggleShow:function(e,t){if(!this.layerObj&&this.gisBase&&this.data&&this.data.length>0){var a=this.data[0];this._updateDataMeta(a.datasetMeta),this.layerObj=this.buildRegionVector(a)}this.layerObj&&(e&&t?this.$emit("updateVecLayer",{id:this.compConf.compId,type:"region",layerObj:this.layerObj,show:!0,toggle:!0}):e&&!t?this.$emit("clearVecLayer",{id:this.compConf.compId,show:!1,toggle:!0}):this.notifyBase())},_clickByLinkAge:function(e){var t=this;this.$evtBus.on(e,(function(e){t.styleConf.dynamicRef&&t.updateRefKey(e)}))},updateRefKey:function(e){var t=[];e.refData.forEach((function(a){var i=a.cond,s=a.to.split("$")[1],r=e.data[a.from.split("$")[1]];t.push({operationType:i,bindMapperColumn:s,value:r})}));var a={target:e.target,source:e.source,name:e.name,data:t,sourceData:e.data},i={};i[this.compConf.compId]=Object(r["a"])({},"".concat(e.name),a),this.$store.commit("setLinkage",i);var s=e.switchVisible&&e.switchVisible[this.compConf.compId]&&e.switchVisible.hasOwnProperty(this.compConf.compId);e.ctrlShow&&(this.showLayer=s),this.toggleShow(e.ctrlShow,s)},linkageConfChanged:function(){this.$store.getters.getPreviewState||this.bindEvent()},loadLinkage:function(e){if(this.compConf.linkage&&this.compConf.linkage.linkEvents)for(var t=this.compConf.linkage.linkEvents,a=0;a<t.length;a++){var i=t[a];if("click"===i.evtType&&i.explosive){var s={data:e};this.$evtBus.emit(i.evtName,s)}}}}},y=d,p=(a("df2c"),a("5d22")),u=Object(p["a"])(y,i,s,!1,null,"7c341b00",null);t["default"]=u.exports}}]);